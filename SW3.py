import os
from re import L

list = []

# [SW3-01]
cmd_list = []
sw1 = {}
cmd=os.popen('systeminfo | find "KB"').read().splitlines() #핫픽스가 있는지 없는지 체크
cmd_up=os.popen('sc query state=inactive |find "Windows Update"').read() #자동업데이트 되어있는지 (window update) 없으면 Null

for i in cmd :
    cmd_list.append(i.split(':')[1].strip())
sw1['HotFix Value'] = cmd_list

if len(cmd_up) == 0 :
    sw1['WindowUpdate'] = 'Null'
else :
    sw1['WindowUpdate'] = cmd_up.split(':')[1].strip()
list.append("SW3-01 : {}".format(sw1))
# print(cmd)
# print(cmd_up)

# list.append(cmd)
# list.append(cmd_up)


# if "KB" in sw1:
#     if "Running Windows Update= Windows Update" in sw1_up:
#         print("양호!")
#     else :
#         print("취약! 윈도우 자동 업데이트 실행 필요")
# else :
#     print("취약! 핫픽스 안깔려있음")

# [SW3-02]
sw2 = []
cmd=os.popen('sc query | findstr /i "ALYac Hauri V3 test Symantec AVG"').read().replace("DISPLAY_NAME:", "Running vaccine = ").splitlines()
if len(cmd) == 0 :
    list.append("SW3-02 : Value is Null")
else:
    for i in cmd :
        if 'SERVICE_NAME' in i :
            continue
        sw2.append(i)
    list.append("SW3-02 : {}".format(sw2))


# if "Running vaccine" in sw2:
#     if "Update" in sw2:
#         print("양호!")
#     else :
#         print("백신은 구동중이나 백신 업데이트가 꺼져있음.")
# else:
#     print("취약! 백신도 구동중이지 않음")


# [SW3-03]
os.system('secedit /export /cfg .\\test.inf')
text = open('.\\test.inf', 'rb')
y = text.read()
x = y.decode('utf-16')
#print(x)

text.close()
sw3 = []
result = x.splitlines()
for x in result :
    if 'AuditLogonEvents' in x : # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
    if 'AuditPrivilegeUse' in x:  # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
    if 'AuditPolicyChange' in x:  # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
    if 'AuditAccountManage' in x:  # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
    if 'AuditDSAccess' in x:  # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
    if 'AuditAccountLogon' in x:  # 설정값이 0이면 감사안함 = 취약 1이면 양호
        sw3.append(x)
list.append("SW3-03 : {}".format(sw3))


# if ('AuditLogonEvents = 0' in sw3 or 'AuditPrivilegeUse=0' in sw3  or AuditPolicyChange=="0" in sw3  or AuditAccountManage=="0" in sw3  or AuditDSAccess=="0" in sw3  or AuditAccountLogon=="0" in sw3 ):
#     print("취약!")
# else:
#     print("양호")

# [SW3-04]


# [SW3-05]
sw5 = []
cmd=os.popen('sc query | find /i "Remote Registry"').read()
print(cmd)
if len(cmd) == 0 :
    sw5.append('Remote Registry Service is Not enabled')
else :
    if 'Remote Registry' in cmd :
        sw5.append('Remote Registry Service is enabled')
list.append("SW3-05 : {}".format(sw5))
# list.append("Remote Registry = "+cmd)


# if "Remote Registry=Remote Registry" in list:
#     print("SW3-05 취약!")
# else:
#     print("SW3-05 양호!")

# [SW3-06]
dict ={}
sw6 = []
cmd_app=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Application" | find /I "MaxSize"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()
cmd_app_ret=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Application" | find /I "Retention"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()
cmd_sys=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\System" | find /I "MaxSize"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()
cmd_sys_ret=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\System" | find /I "Retention"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()
cmd_sec=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Security" | find /I "MaxSize"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()
cmd_sec_ret=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Security" | find /I "Retention"').readlines()[0].strip('\n')[4:].split('REG_DWORD')[1].strip()

dict['name'] = 'Application'
dict['size'] = cmd_sys
dict['retention'] = cmd_sys_ret
sw6.append(dict)
dict ={}
dict['name'] = 'Application'
dict['size'] = cmd_sec
dict['retention'] = cmd_sec_ret
sw6.append(dict)

dict ={}
dict['name'] = 'Application'
dict['size'] = cmd_app
dict['retention'] = cmd_app_ret
sw6.append(dict)


list.append("SW3-06 : {}".format(sw6))
# MaxSize
# 0xa00000 : 10,240KB
# 20480


# Retention
# 0xffffffff : 로그가 꽉 차면 로그 보관, 이벤트를 덮어쓰지않음 / 이벤트를 덮어쓰지 않음
# 0x0 : 필요한 경우 이벤트 덮어쓰기




# list.append("SW6 Eventlog/Application/Maxsize = "+sw6AM)
# list.append("SW6 Eventlog/Application/Retention = "+sw6AR)
# list.append("SW6 Eventlog/System/Maxsize = "+sw6SyM)
# list.append("SW6 Eventlog/System/Retention = "+sw6SyR)
# list.append("SW6 Eventlog/Security/Maxsize = "+sw6SeM)
# list.append("SW6 Eventlog/Security/Retention = "+sw6SeR)

# if (int(sw6AM,16)/1024) < 10240 or (int(sw6SyM,16)/1024) < 10240 or (int(sw6SeM,16)/1024) < 10240 :
#     print("SW3-06 취약!")
# else:
#     if (int(sw6AR,16)) > 90 or (int(sw6SyR,16)) > 90 or (int(sw6SeR,16)) > 90 :
#         print("SW3-06 취약!")
#     else :
#         print("SW3-06 양호!")

#[SW3-07]
dict = {}
sw7 = []

cmd=os.popen('cacls %systemroot%\system32\logfiles | find "Everyone"').read()
if len(cmd) == 0 :
    cmd = 'Value is None'
dict['name'] = 'logfile'
dict['value'] = cmd
sw7.append(dict)

cmd=os.popen('cacls %systemroot%\system32\config | find "Everyone"').read()
if len(cmd) == 0 :
    cmd = 'Value is None'
dict = {}
dict['name'] = 'config'
dict['value'] = cmd
sw7.append(dict)
list.append("SW3-07 :{}".format(sw7))

# list.append("SW7 logfiles Everyone 권한여부 = "+sw7log)
# list.append("SW7 config Everyone 권한여부 = "+sw7con)
# if "Everyone" in sw7[0]['value']:
#     print("SW3-07 취약!")
# else:
#     if "Everyone" in sw7[0]['value'] :
#         print("SW3-07 취약!")
#     else :
#         print("SW3-07양호!")

#[SW3-08]
sw8 = {}
cmd=os.popen('sc query state=inactive |find "Windows Update"').read() #자동업데이트 되어있는지 (window update) 없으면 Null
if len(cmd) == 0 :
    sw8['SW8 MS Patch'] = 'Null'
else :
    sw8['SW8 MS Patch'] = cmd_up.split(':')[1].strip()
list.append("SW3-08 :{}".format(sw8))

#[SW3-09]
sw9 = []
cmd_sys=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\System" /v RestrictGuestAccess').read().strip().split(" ")[12]
cmd_app=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Application" /v RestrictGuestAccess').read().strip().split(" ")[12]
cmd_sec=os.popen('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Security" /v RestrictGuestAccess').read().strip().split(" ")[12]
sw9.append("System RestrictGuestAccess=" + cmd_sys)
sw9.append("Application RestrictGuestAccess=" + cmd_app)
sw9.append("Security  RestrictGuestAccess=" + cmd_sec)
list.append("SW3-09 :{}".format(sw9))
# list.append("SW9 Eventlog\System guest 권한여부 = "+cmd_sys)
# list.append("SW9 Eventlog\Application guest 권한여부 = "+cmd_app)
# list.append("SW9 Eventlog\Security guest 권한여부 = "+cmd_sec)
# if "SW9 Eventlog\System guest 권한여부 = 0x1" in list and "SW9 Eventlog\Application guest 권한여부 = 0x1" in list and "SW9 Eventlog\Security guest 권한여부 = 0x1" in list :
#     print("SW3-09 양호!")
# else:
#     print("SW3-09 취약!")
for i in list :
    print(i)
